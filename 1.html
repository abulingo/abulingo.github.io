<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abulingo - Flashcards</title>
    
    <link rel="preconnect" href="https://zdybpplggppjrmxhfhik.supabase.co" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" media="print" onload="this.media='all'"></link>
    <link rel="stylesheet" href="style.css">   
    <link rel="icon" href="icono.png" type="image/x-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Work Sans', sans-serif; }
        .card-style { background-color: white; box-shadow: 0 10px 25px -5px rgb(0 0 0 / 0.05), 0 8px 10px -6px rgb(0 0 0 / 0.05); will-change: transform; }
        .btn-primary { background-color: #FF7A00; color: white; }
        .font-heading { font-family: 'Space Grotesk', sans-serif; }
        
        /* Optimizaci칩n de animaciones usando GPU */
        #points-hud {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 10px 24px;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 2px solid #f1f5f9;
            font-family: 'Space Grotesk', sans-serif;
            font-weight: bold;
            font-size: 1.25rem;
            color: #475569;
            margin-bottom: 2rem;
            transition: transform 0.2s;
            will-change: transform;
        }

        @keyframes floatUpFade {
            0% { opacity: 0; transform: translateY(10px) scale(0.8); }
            20% { opacity: 1; transform: translateY(0px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-50px) scale(1); }
        }

        .points-floater {
            position: absolute;
            font-weight: 900;
            font-size: 1.5rem;
            color: #FF7A00;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
            pointer-events: none;
            z-index: 100;
            animation: floatUpFade 1.5s ease-out forwards;
            will-change: transform, opacity; /* Ayuda al navegador a optimizar */
        }

        @keyframes pulse-gold {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); color: #eab308; }
            100% { transform: scale(1); }
        }

        .animate-score-pulse { animation: pulse-gold 0.4s ease-in-out; }
        .star-icon { color: #fbbf24; font-size: 1.5rem; }
        
        /* Clases utilitarias para evitar reflow */
        .min-card-h { min-height: 500px; }
    </style>
</head>
<body class="min-h-screen">

    <div id="navBarra"></div>
    
    <audio id="success-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="metadata"></audio>

    <main class="pt-24 pb-12 flex flex-col items-center min-h-screen">
        
        <div class="w-full flex justify-center h-20"> <div id="points-hud" class="hidden">
                <i class="fas fa-star star-icon" id="hud-star"></i>
                <span id="user-points-display">0</span>
            </div>
        </div>

        <div id="app-container" class="w-full max-w-2xl mx-auto px-4 min-card-h flex flex-col justify-center">
            <div class="text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mb-4"></div>
                <h1 class="text-3xl font-bold font-heading">Cargando Flashcards...</h1>
                <p class="text-slate-600">Sincronizando con la nube.</p>
            </div>
        </div>
    </main>

    <script type="module">
        // --- 1. CONFIGURACI칍N ---
        const SUPABASE_URL = 'https://zdybpplggppjrmxhfhik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeWJwcGxnZ3BwanJteGhmaGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODY0MTcsImV4cCI6MjA3NDc2MjQxN30._1LRLhgIsNnc48Tj431F7xRWwHma0WCkc613ztmpjtU';

        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- CACH칄 DOM (Optimizaci칩n JS) ---
        const DOM = {
            appContainer: document.getElementById('app-container'),
            pointsHud: document.getElementById('points-hud'),
            pointsDisplay: document.getElementById('user-points-display'),
            hudStar: document.getElementById('hud-star'),
            audio: document.getElementById('success-sound'),
            body: document.body
        };

        let currentUser = null;
        let userProfile = null;
        let currentWord = null;

        const srsIntervals = [600000, 86400000, 259200000, 604800000, 1209600000, 2592000000]; // Pre-calculados en ms

        // --- 2. L칍GICA OPTIMIZADA ---

        async function updateWordProgress(wordId, wasCorrect) {
            if (!currentUser) return;
            
            // Optimizaci칩n: Fetch optimista o paralelo si fuera posible, aqu칤 mantenemos la l칩gica segura
            const { data: progress } = await dbClient.from('user_word_progress')
                .select('srs_level')
                .eq('user_id', currentUser.id)
                .eq('word_id', wordId)
                .maybeSingle(); // maybeSingle es m치s r치pido que single si puede no existir
            
            let newSrsLevel = progress ? progress.srs_level : 0;
            newSrsLevel = wasCorrect ? newSrsLevel + 1 : 0;
            
            const interval = srsIntervals[Math.min(newSrsLevel, srsIntervals.length - 1)];
            const next_review_at = new Date(Date.now() + interval).toISOString();
            
            const { error } = await dbClient.from('user_word_progress').upsert({ 
                user_id: currentUser.id, 
                word_id: wordId, 
                srs_level: newSrsLevel, 
                next_review_at: next_review_at 
            }, { onConflict: 'user_id, word_id' });
            
            if (wasCorrect) updateUserPoints(5); // No usamos await para no bloquear la UI
        }

        function updateUserPoints(pointsToAdd) {
            if (!userProfile) return;
            
            const newPoints = (userProfile.points || 0) + pointsToAdd;
            userProfile.points = newPoints;
            
            // 1. Actualizar UI Inmediatamente (Optimistic UI update)
            DOM.pointsDisplay.textContent = newPoints;
            
            // 2. Reproducir sonido
            if(DOM.audio) {
                DOM.audio.currentTime = 0;
                DOM.audio.volume = 0.5;
                DOM.audio.play().catch(() => {});
            }

            // 3. Animaciones
            requestAnimationFrame(() => {
                // Flotante
                const floatingEl = document.createElement('div');
                floatingEl.textContent = `+${pointsToAdd}`;
                floatingEl.className = 'points-floater';
                
                const rect = DOM.pointsHud.getBoundingClientRect();
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                floatingEl.style.left = `${rect.left + rect.width/2}px`;
                floatingEl.style.top = `${rect.top + scrollTop}px`;
                
                DOM.body.appendChild(floatingEl);
                setTimeout(() => floatingEl.remove(), 1500);

                // Pulso
                DOM.pointsDisplay.classList.remove('animate-score-pulse');
                DOM.hudStar.classList.remove('animate-score-pulse');
                void DOM.pointsDisplay.offsetWidth; // Force reflow
                DOM.pointsDisplay.classList.add('animate-score-pulse');
                DOM.hudStar.classList.add('animate-score-pulse');
            });

            // 4. Guardar en DB en segundo plano
            dbClient.from('profiles').update({ points: newPoints }).eq('id', currentUser.id).then();
        }

        async function renderFlow1_Flashcards() {
            // Mostrar estado de carga "suave" si tarda mucho, o mantener la carta anterior
            // Aqu칤 optamos por velocidad: buscar la palabra
            const word = await getNextWordForReview();
            
            if (word) {
                currentWord = word;
                // Usamos requestAnimationFrame para asegurar que el pintado ocurre en el frame correcto
                requestAnimationFrame(() => {
                    DOM.appContainer.innerHTML = getFlashcardHTML(word);
                    addFlashcardEventListeners();
                });
            } else {
                DOM.appContainer.innerHTML = getCompletionHTML();
                document.getElementById('btn-reload').addEventListener('click', () => window.location.reload());
            }
        }

        // --- GENERACI칍N DE HTML (Template Strings) ---
        // Placeholder SVG base64 muy ligero para evitar una petici칩n HTTP extra a via.placeholder
        const placeholderImg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 200'%3E%3Crect width='400' height='200' fill='%23e6f0ff'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-size='20' fill='%230d47a1'%3EAbulingo%3C/text%3E%3C/svg%3E";

        function getFlashcardHTML(word) {
            const imgSrc = word.imagen || placeholderImg;
            
            return `
                <div id="flashcard-container" class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center transition-all duration-300">
                    <img id="card-image" 
                         src="${imgSrc}" 
                         alt="${word.ingles}" 
                         class="rounded-lg mb-4 w-full object-cover h-48 bg-slate-100"
                         loading="eager" 
                         fetchpriority="high">
                    
                    <h1 class="text-5xl font-bold font-heading mb-1 text-slate-800">${word.ingles}</h1>
                    <p class="text-xl text-slate-500 opacity-75 mb-4">${word.espanol}</p>
                    <p id="card-phonetic" class="text-lg font-mono text-[#FF7A00] mb-4 hidden">${word.fonetica || ''}</p>
                    
                    <div class="flex justify-center space-x-4 mb-6">
                        <button id="pronounce-btn" class="flex-1 bg-blue-50 text-blue-700 font-semibold py-3 rounded-xl hover:bg-blue-100 transition duration-200 flex items-center justify-center space-x-2 touch-manipulation">
                            <i class="fas fa-volume-up"></i><span>Sonido</span>
                        </button>
                        <button id="phonetic-btn" class="flex-1 bg-blue-50 text-blue-700 font-semibold py-3 rounded-xl hover:bg-blue-100 transition duration-200 flex items-center justify-center space-x-2 touch-manipulation">
                            <i class="fas fa-language"></i><span>Fon칠tica</span>
                        </button>
                    </div>
                    
                    <div class="flex space-x-4">
                        <button id="btn-easy" class="w-1/2 py-4 rounded-xl font-bold transition duration-200 text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 touch-manipulation transform active:scale-95">F치cil</button>
                        <button id="btn-hard" class="w-1/2 py-4 rounded-xl font-bold transition duration-200 text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 touch-manipulation transform active:scale-95">Dif칤cil</button>
                    </div>
                </div>`;
        }

        function getCompletionHTML() {
            return `
                <div class="text-center card-style w-full max-w-md mx-auto p-8 rounded-2xl animate-fade-in">
                    <div class="mb-6 text-6xl animate-bounce">游꿀</div>
                    <h2 class="text-2xl font-bold font-heading mb-4">춰Est치s al d칤a!</h2>
                    <p class="text-slate-600 mb-8">Has repasado todas las palabras de este grupo.</p>
                    <button id="btn-reload" class="w-full btn-primary py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition transform hover:scale-105">
                        <i class="fas fa-sync-alt ml-2"></i> Volver a comprobar
                    </button>
                </div>`;
        }

        function addFlashcardEventListeners() {
            // Usamos delegaci칩n de eventos si fuera posible, pero direct ID es r치pido aqu칤
            document.getElementById('pronounce-btn').onclick = () => {
                if (currentWord && currentWord.audio) new Audio(currentWord.audio).play();
            };
            document.getElementById('phonetic-btn').onclick = () => {
                document.getElementById('card-phonetic').classList.remove('hidden'); 
            };
            
            const handleResponse = (isEasy) => {
                // UI Feedback inmediato (opacidad) para que el usuario sienta rapidez
                document.getElementById('flashcard-container').style.opacity = '0.5';
                updateWordProgress(currentWord.id, isEasy); // Async en background
                renderFlow1_Flashcards(); // Pasa a la siguiente
            };
            
            document.getElementById('btn-easy').onclick = () => handleResponse(true);
            document.getElementById('btn-hard').onclick = () => handleResponse(false);
        }

        // --- 3. QUERIES DE DATOS (Optimizadas) ---
        async function getNextWordForReview() {
            const now = new Date().toISOString(); 
            const group = userProfile.flujo.currentGroup;
            
            // Intenta traer la palabra de repaso
            let { data: review } = await dbClient.from('user_word_progress')
                .select(`srs_level, palabras!inner(*)`)
                .eq('user_id', currentUser.id)
                .eq('palabras.grupo', group)
                .lte('next_review_at', now)
                .order('next_review_at')
                .limit(1)
                .maybeSingle();
            
            if (review) return { ...review.palabras, srs_level: review.srs_level };
            
            // Si no hay repaso, busca nueva
            // Optimizaci칩n: Traer IDs vistos en una query ligera
            const { data: seen } = await dbClient.from('user_word_progress').select('word_id').eq('user_id', currentUser.id);
            const seenIds = seen && seen.length > 0 ? seen.map(w => w.word_id) : []; // Manejo seguro de array vac칤o
            
            let query = dbClient.from('palabras').select('*').eq('grupo', group);
            
            // Solo aplicamos el filtro NOT IN si hay vistos, para no romper la query
            if (seenIds.length > 0) {
                query = query.not('id', 'in', `(${seenIds.join(',')})`);
            }
            
            const { data: newWord } = await query.order('id').limit(1).maybeSingle();
            return newWord ? { ...newWord, srs_level: 0 } : null;
        }

        async function initApp() {
            // Verificar sesi칩n
            const { data: { session } } = await dbClient.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            
            currentUser = session.user;

            // PARALELIZACI칍N: Cargar Perfil y Datos Iniciales al mismo tiempo
            // No esperamos al perfil para cargar la UI si es posible, pero aqu칤 lo necesitamos para el Grupo
            const profilePromise = dbClient.from('profiles').select('*').eq('id', currentUser.id).single();
            
            const [profileResult] = await Promise.all([profilePromise]);
            
            if (profileResult.error) {
                console.error("Error perfil", profileResult.error);
                return;
            }

            userProfile = profileResult.data;

            // Actualizar HUD inmediatamente
            DOM.pointsHud.classList.remove('hidden');
            DOM.pointsDisplay.textContent = userProfile.points || 0;
            const userNameNav = document.getElementById('user-name-nav');
            if(userNameNav) userNameNav.textContent = userProfile.full_name || 'Estudiante';

            // Iniciar flujo
            await renderFlow1_Flashcards();
        }

        // Ejecutar inmediatamente al cargar
        initApp();

    </script>
    
    <script src="js/igual1.js" defer></script> 
</body>
</html>