<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abulingo - Aprende Ingl√©s</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <link rel="stylesheet" href="style.css">   
    <link rel="icon" href="icono.png" type="image/x-icon">

    <style>
        .pt-20 {
            padding-top: 4.2rem !important; 
        }
        body { background-color: #f8fafc; }
        .card-style { background-color: white; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: #FF7A00; color: white; }
        .font-heading { font-family: 'Space Grotesk', sans-serif; }
        
        #points-hud {
            display: inline-flex; align-items: center; gap: 12px; background: white;
            padding: 10px 24px; border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 2px solid #f1f5f9;
            font-family: 'Space Grotesk', sans-serif; font-weight: bold; font-size: 1.25rem;
            color: #475569; margin-bottom: 0.25rem; transition: transform 0.2s;
        }

        @keyframes floatUpFade {
            0% { opacity: 0; transform: translateY(10px) scale(0.8); }
            20% { opacity: 1; transform: translateY(0px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-50px) scale(1); }
        }

        .points-floater {
            position: absolute; font-weight: 900; font-size: 1.5rem; color: #FF7A00;
            text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8); pointer-events: none; z-index: 100;
            animation: floatUpFade 1.5s ease-out forwards;
        }

        @keyframes pulse-gold {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); color: #eab308; }
            100% { transform: scale(1); }
        }

        .animate-score-pulse { animation: pulse-gold 0.4s ease-in-out; }
        .star-icon { color: #fbbf24; font-size: 1.5rem; }
    </style>
</head>
<body class="min-h-screen">

    <div id="navBarra"></div>
    <audio id="success-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3" preload="auto"></audio>

    <main class="pt-20 pb-12 flex flex-col items-center min-h-screen px-2">
        
        <div class="w-full flex justify-center">
            <div id="points-hud" class="hidden">
                <i class="fas fa-star star-icon" id="hud-star"></i>
                <span id="user-points-display">0</span>
            </div>
        </div>

        <div id="app-container" class="w-full max-w-lg mx-auto">
            <div class="text-center">
                <h1 class="text-3xl font-bold font-heading">Cargando...</h1>
                <p class="text-slate-600"><i class="fas fa-spinner fa-spin"></i> Preparando lecciones</p>
            </div>
        </div>
    </main>

    <script type="module">
        // --- 1. CONFIGURACI√ìN INICIAL ---
        const SUPABASE_URL = 'https://zdybpplggppjrmxhfhik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeWJwcGxnZ3BwanJteGhmaGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODY0MTcsImV4cCI6MjA3NDc2MjQxN30._1LRLhgIsNnc48Tj431F7xRWwHma0WCkc613ztmpjtU';

        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, userProfile = null, currentWord = null;
        const appContainer = document.getElementById('app-container');

        // --- 2. L√ìGICA DEL SRS ---
        const srsIntervals = [10 * 60 * 1000, 24 * 60 * 60 * 1000, 3 * 24 * 60 * 60 * 1000, 7 * 24 * 60 * 60 * 1000, 14 * 24 * 60 * 60 * 1000, 30 * 24 * 60 * 60 * 1000];
        
        async function updateWordProgress(wordId, wasCorrect) {
            if (!currentUser) return;
            const { data: progress } = await dbClient.from('user_word_progress').select('srs_level').eq('user_id', currentUser.id).eq('word_id', wordId).maybeSingle();
            let newSrsLevel = progress ? progress.srs_level : 0;
            newSrsLevel = wasCorrect ? newSrsLevel + 1 : 0;
            const interval = srsIntervals[Math.min(newSrsLevel, srsIntervals.length - 1)];
            const next_review_at = new Date(Date.now() + interval).toISOString();
            const { error } = await dbClient.from('user_word_progress').upsert({ user_id: currentUser.id, word_id: wordId, srs_level: newSrsLevel, next_review_at: next_review_at }, { onConflict: 'user_id, word_id' });
            if (error) console.error("Error al actualizar progreso:", error);
            else if (wasCorrect) await updateUserPoints(5);
        }

        async function updateUserPoints(pointsToAdd) {
            const currentPoints = userProfile.points || 0;
            const newPoints = currentPoints + pointsToAdd;
            
            const audio = document.getElementById('success-sound');
            if(audio) {
                audio.currentTime = 0; 
                audio.volume = 0.5;
                audio.play().catch(e => console.log("Audio play blocked"));
            }

            const hud = document.getElementById('points-hud');
            const pointsDisplay = document.getElementById('user-points-display');
            const starIcon = document.getElementById('hud-star');
            
            const floatingEl = document.createElement('div');
            floatingEl.textContent = `+${pointsToAdd}`;
            floatingEl.className = 'points-floater';
            
            const rect = hud.getBoundingClientRect();
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            floatingEl.style.left = `${rect.left + scrollLeft + rect.width/2}px`;
            floatingEl.style.top = `${rect.top + scrollTop}px`;
            
            document.body.appendChild(floatingEl);
            setTimeout(() => { floatingEl.remove(); }, 1500);

            if(pointsDisplay) {
                pointsDisplay.textContent = newPoints;
                pointsDisplay.classList.remove('animate-score-pulse');
                starIcon.classList.remove('animate-score-pulse');
                void pointsDisplay.offsetWidth; 
                pointsDisplay.classList.add('animate-score-pulse');
                starIcon.classList.add('animate-score-pulse');
            }

            userProfile.points = newPoints;
            const { error } = await dbClient.from('profiles').update({ points: newPoints }).eq('id', currentUser.id);
        }

        // --- 3. L√ìGICA DE FLUJOS ---
        async function iniciarFlujoDeAprendizaje() {
            if (!userProfile || !userProfile.flujo) {
                appContainer.innerHTML = `<h2 class="text-center font-bold">Error: No se encontr√≥ flujo de aprendizaje.</h2>`;
                return;
            }
            switch (userProfile.flujo.currentFlow) {
                case 1: await renderFlow1_Flashcards(); break;
                case 2: await renderFlow2_Practice(); break;
                default: await advanceToNextGroup();
            }
        }

       async function renderFlow1_Flashcards() {
            const word = await getNextWordForReview();
            if (word) {
                currentWord = word;
                appContainer.innerHTML = getFlashcardHTML(word);
                addFlashcardEventListeners();
                
                if (word.audio && word.audio.trim() !== "") {
                    setTimeout(() => {
                        const audio = new Audio(word.audio);
                        audio.play().catch(e => console.log("Autoplay bloqueado:", e.message));
                    }, 500);
                }

            } else {
                appContainer.innerHTML = `
                    <div class="text-center card-style w-full max-w-lg mx-auto p-8 rounded-2xl">
                        <div class="mb-6 text-6xl">üéâ</div>
                        <h2 class="text-2xl font-bold font-heading mb-4">Vocabulario Repasado</h2>
                        <p class="text-slate-600 mb-8">Has visto todas las palabras nuevas. ¬°Vamos a practicar!</p>
                        <button id="btn-advance-flow" class="w-full btn-primary py-4 rounded-xl font-bold text-lg shadow-lg hover:opacity-90 transition transform hover:scale-105">
                            Comenzar Pr√°ctica <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                `;
                document.getElementById('btn-advance-flow').addEventListener('click', async () => {
                    const btn = document.getElementById('btn-advance-flow');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
                    btn.disabled = true;
                    const newFlowState = userProfile.flujo;
                    newFlowState.currentFlow = 2; 
                    if(newFlowState.flowState[newFlowState.currentGroup].flow1_flashcards) {
                        newFlowState.flowState[newFlowState.currentGroup].flow1_flashcards.status = "completed";
                    }
                    await updateUserFlowState(newFlowState);
                    await renderFlow2_Practice();
                });
            }
        }
        
        async function renderFlow2_Practice() {
            const flowState = userProfile.flujo.flowState[userProfile.flujo.currentGroup];
            if (!flowState.flow2_practice.queue || flowState.flow2_practice.queue.length === 0) {
                await generatePracticeQueue();
                await loadUserProfile();
            }
            const queue = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow2_practice.queue;
            const currentIndex = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow2_practice.currentIndex || 0;
            
            if (currentIndex >= queue.length) {
                const newFlowState = userProfile.flujo;
                newFlowState.flowState[newFlowState.currentGroup].flow2_practice.status = "completed";
                await updateUserFlowState(newFlowState);
                await advanceToNextGroup();
                return;
            }

            const exercise = queue[currentIndex];
            const { data: wordData, error } = await dbClient.from('palabras').select('*').eq('id', exercise.word_id).single();
            if (error) { console.error("No se pudo cargar la palabra:", error); return; }
            
            currentWord = wordData;
            switch (exercise.type) {
                case 'select_word_by_image': await renderSelectWordByImageExercise(wordData, exercise.options); break;
                case 'write_word_by_audio': renderWriteWordByAudioExercise(wordData); break;
                default: await advanceInQueue();
            }
        }

        // --- RENDERIZADO (Con cambio a texto Azul) ---

        function getFlashcardHTML(word) {
            return `
                <div id="flashcard-container" class="card-style w-full max-w-lg mx-auto p-6 md:p-8 rounded-2xl text-center">
                    <div class="w-full h-64 md:h-96 mb-2 bg-slate-50 rounded-xl overflow-hidden flex items-center justify-center border border-slate-100">
                        <img id="card-image" src="${word.imagen || `https://via.placeholder.com/400/200/e6f0ff/0d47a1?text=${word.ingles}`}" 
                             alt="Imagen de la palabra" 
                             class="w-full h-full object-contain">
                    </div>

                    <h1 id="card-english" class="text-4xl md:text-5xl font-bold font-heading mb-1 text-blue-600">${word.ingles}</h1>
                    <p id="card-spanish" class="text-xl text-slate-500 opacity-75 mb-2">${word.espanol}</p>
                    <p id="card-phonetic" class="text-lg font-mono text-[#FF7A00] mb-2 hidden">${word.fonetica || ''}</p>
                    
                    <div class="flex justify-center space-x-3 mb-2">
                        <button id="pronounce-btn" class="flex-1 bg-blue-50 text-[#0D47A1] font-semibold py-3 rounded-xl hover:bg-blue-100 transition flex items-center justify-center space-x-2 border border-blue-100">
                            <i class="fas fa-volume-up"></i><span>Sonido</span>
                        </button>
                        <button id="phonetic-btn" class="flex-1 bg-blue-50 text-[#0D47A1] font-semibold py-3 rounded-xl hover:bg-blue-100 transition flex items-center justify-center space-x-2 border border-blue-100">
                            <i class="fas fa-language"></i><span>Fon√©tica</span>
                        </button>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button id="btn-easy" class="w-1/2 py-4 rounded-xl font-bold transition text-green-700 bg-green-100 hover:bg-green-200 border border-green-200 shadow-sm">F√°cil</button>
                        <button id="btn-hard" class="w-1/2 py-4 rounded-xl font-bold transition text-red-700 bg-red-100 hover:bg-red-200 border border-red-200 shadow-sm">Dif√≠cil</button>
                    </div>
                </div>`;
        }

        async function renderSelectWordByImageExercise(correctWord, options) {
            let optionsHTML = options.sort(() => Math.random() - 0.5).map(option => `<button class="option-button w-full text-lg border-2 border-slate-200 hover:bg-slate-100 py-3 md:py-4 rounded-xl transition font-medium text-slate-700" data-word="${option}">${option}</button>`).join('');
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-lg mx-auto p-6 md:p-8 rounded-2xl text-center">
                    <h2 class="text-xl md:text-2xl font-bold font-heading mb-4 text-slate-800">Selecciona la palabra correcta</h2>
                    
                    <div class="w-full h-56 md:h-80 mb-6 bg-slate-50 rounded-xl overflow-hidden flex items-center justify-center border border-slate-100">
                        <img src="${correctWord.imagen}" alt="Imagen" class="w-full h-full object-contain">
                    </div>

                    <div class="grid grid-cols-2 gap-3 md:gap-4">${optionsHTML}</div>
                </div>`;
            
            document.querySelectorAll('.option-button').forEach(button => button.addEventListener('click', async (e) => {
                const isCorrect = e.target.dataset.word === correctWord.ingles;
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.word === correctWord.ingles) btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                    else if (btn === e.target) btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                });
                await updateWordProgress(correctWord.id, isCorrect);
                setTimeout(advanceInQueue, 1500);
            }));
        }
        
        function renderWriteWordByAudioExercise(word) {
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-lg mx-auto p-6 md:p-8 rounded-2xl text-center">
                    <h2 class="text-xl md:text-2xl font-bold font-heading mb-6 text-slate-800">Escribe lo que escuches</h2>
                    
                    <button id="play-audio-btn" class="mb-8 bg-[#FF7A00] text-white rounded-full h-24 w-24 flex items-center justify-center mx-auto text-4xl hover:opacity-90 transition shadow-lg shadow-orange-200">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    
                    <input id="word-input" type="text" class="w-full border-2 border-slate-200 rounded-xl p-4 text-center text-xl md:text-2xl focus:border-blue-500 focus:outline-none transition mb-4" placeholder="Escribe aqu√≠..." autocomplete="off">
                    
                    <button id="check-btn" class="w-full btn-primary py-4 rounded-xl font-bold text-lg shadow-md mt-2">Comprobar</button>
                    <div id="feedback" class="mt-4 h-10"></div>
                </div>`;
            
            if (word.audio && word.audio.trim() !== "") {
                const audio = new Audio(word.audio);
                document.getElementById('play-audio-btn').addEventListener('click', () => audio.play());
                audio.play().catch(e => console.log("Autoplay bloqueado:", e.message));
            } else {
                 document.getElementById('play-audio-btn').disabled = true;
                 document.getElementById('play-audio-btn').classList.add('opacity-50');
            }

            document.getElementById('word-input').focus();

            document.getElementById('check-btn').addEventListener('click', async () => {
                const input = document.getElementById('word-input'), feedback = document.getElementById('feedback');
                const isCorrect = input.value.trim().toLowerCase() === word.ingles.toLowerCase();
                await updateWordProgress(word.id, isCorrect);
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold text-lg">¬°Correcto!</p>` : `<p class="text-red-600 font-bold">Respuesta: <span class="font-mono text-lg text-slate-800">${word.ingles}</span></p>`;
                document.getElementById('check-btn').disabled = true;
                setTimeout(advanceInQueue, 2000);
            });
            
            document.getElementById('word-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') document.getElementById('check-btn').click();
            });
        }

        async function advanceToNextGroup() {
            appContainer.innerHTML = `
                <div class="text-center card-style w-full max-w-lg mx-auto p-8 rounded-2xl">
                    <div class="mb-6 text-6xl">üèÜ</div>
                    <h2 class="text-2xl font-bold font-heading mb-2">¬°Nivel Completado!</h2>
                    <p class="text-slate-600">Cargando el siguiente grupo de vocabulario...</p>
                </div>`;
            
            const currentGroup = userProfile.flujo.currentGroup;
            const newFlow = userProfile.flujo;
            const currentGroupNumber = parseInt(currentGroup.replace('G', ''));
            const nextGroup = `G${currentGroupNumber + 1}`;
            
            newFlow.currentGroup = nextGroup;
            newFlow.currentFlow = 1; 
            
            if (!newFlow.flowState[nextGroup]) {
                newFlow.flowState[nextGroup] = JSON.parse(JSON.stringify(newFlow.flowState['G1']));
                Object.keys(newFlow.flowState[nextGroup]).forEach(flowKey => {
                      newFlow.flowState[nextGroup][flowKey].status = "not_started";
                });
            }
            await updateUserFlowState(newFlow);
            window.location.reload();
        }

        // --- 5. FUNCIONES AUXILIARES ---
        async function getNextWordForReview() {
            const now = new Date().toISOString(); 
            const group = userProfile.flujo.currentGroup;
            
            const { data: review } = await dbClient.from('user_word_progress').select(`srs_level, palabras!inner(*)`).eq('user_id', currentUser.id).eq('palabras.grupo', group).lte('next_review_at', now).order('next_review_at').limit(1).maybeSingle();
            
            if (review) return { ...review.palabras, srs_level: review.srs_level };
            
            const { data: seen } = await dbClient.from('user_word_progress').select('word_id').eq('user_id', currentUser.id);
            const seenIds = seen ? seen.map(w => w.word_id) : [];
            let query = dbClient.from('palabras').select('*').eq('grupo', group);
            if (seenIds.length > 0) query = query.not('id', 'in', `(${seenIds.join(',')})`);
            
            const { data: newWord } = await query.order('id').limit(1).maybeSingle();
            return newWord ? { ...newWord, srs_level: 0 } : null;
        }

        async function generatePracticeQueue() {
            const group = userProfile.flujo.currentGroup;
            const { data: words } = await dbClient.from('palabras').select('id, ingles').eq('grupo', group);
            if (!words) return;
            const types = ['select_word_by_image', 'write_word_by_audio'];
            let queue = words.map(word => {
                const type = types[Math.floor(Math.random() * types.length)];
                let exercise = { type, word_id: word.id };
                if (type === 'select_word_by_image') {
                    let options = [word.ingles];
                    let others = words.filter(w => w.id !== word.id).sort(() => .5 - Math.random()).slice(0, 3);
                    options.push(...others.map(w => w.ingles));
                    exercise.options = options;
                }
                return exercise;
            }).sort(() => Math.random() - 0.5);
            const newFlow = userProfile.flujo;
            newFlow.flowState[group].flow2_practice = { status: "in_progress", queue, currentIndex: 0 };
            await updateUserFlowState(newFlow);
        }

        async function advanceInQueue() {
            const flow = userProfile.flujo;
            flow.flowState[flow.currentGroup].flow2_practice.currentIndex++;
            await updateUserFlowState(flow);
            await renderFlow2_Practice();
        }

        function addFlashcardEventListeners() {
            document.getElementById('pronounce-btn').addEventListener('click', () => {
                if (currentWord && currentWord.audio) new Audio(currentWord.audio).play();
            });
            document.getElementById('phonetic-btn').addEventListener('click', () => {
                const phoneticEl = document.getElementById('card-phonetic');
                if (phoneticEl) phoneticEl.classList.remove('hidden'); 
            });
            const handleResponse = async (isEasy) => {
                await updateWordProgress(currentWord.id, isEasy);
                await renderFlow1_Flashcards();
            };
            document.getElementById('btn-easy').addEventListener('click', () => handleResponse(true));
            document.getElementById('btn-hard').addEventListener('click', () => handleResponse(false));
        }

        async function loadUserProfile() {
            const { data, error } = await dbClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if (error) console.error("Error al cargar perfil:", error);
            userProfile = data;
        }

        async function updateUserFlowState(newFlowState) {
            const { error } = await dbClient.from('profiles').update({ flujo: newFlowState }).eq('id', currentUser.id);
            if (error) console.error("Error al actualizar flujo:", error);
            else userProfile.flujo = newFlowState;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await dbClient.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            await loadUserProfile();
            if (userProfile) {
                const pointsHud = document.getElementById('points-hud');
                const pointsDisplay = document.getElementById('user-points-display');
                if(pointsHud) pointsHud.classList.remove('hidden');
                if(pointsDisplay) pointsDisplay.textContent = userProfile.points || 0;

                setTimeout(() => {
                    const userNameNav = document.getElementById('user-name-nav');
                    const userNameDropdown = document.getElementById('user-name-dropdown');
                    const userEmailDropdown = document.getElementById('user-email-dropdown');
                    const logoutBtn = document.getElementById('logout-btn');

                    if(userNameNav) userNameNav.textContent = userProfile.full_name || 'Mi Perfil';
                    if(userNameDropdown) userNameDropdown.textContent = userProfile.full_name || 'Sin nombre';
                    if(userEmailDropdown) userEmailDropdown.textContent = currentUser.email;
                    if(logoutBtn) logoutBtn.addEventListener('click', async () => {
                        await dbClient.auth.signOut();
                        window.location.href = 'index.html';
                    });
                }, 500);

                await iniciarFlujoDeAprendizaje();
            }
        });
    </script>
    
    <script src="js/igual1.js"></script> 
</body>
</html>