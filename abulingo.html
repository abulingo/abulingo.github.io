<<<<<<< HEAD
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abulingo - Aprende Inglés</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <link rel="stylesheet" href="style.css">   
    <link rel="icon" href="icono.png" type="image/x-icon">
</head>
<body class="min-h-screen">

    <div id="navBarra"></div>

    <main class="pt-24 pb-12 flex flex-col items-center justify-center min-h-screen">
        <div id="app-container" class="w-full max-w-2xl mx-auto px-4">
            <div class="text-center"><h1 class="text-3xl font-bold font-heading">Cargando tu aventura...</h1><p class="text-slate-600">Por favor, espera un momento.</p></div>
        </div>
    </main>

    <script type="module">
        const SUPABASE_URL = 'https://zdybpplggppjrmxhfhik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeWJwcGxnZ3BwanJteGhmaGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODY0MTcsImV4cCI6MjA3NDc2MjQxN30._1LRLhgIsNnc48Tj431F7xRWwHma0WCkc613ztmpjtU'

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) alert("¡Error! Debes configurar tus credenciales de Supabase.");

        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, userProfile = null, currentWord = null;
        const appContainer = document.getElementById('app-container');

        // --- 2. LÓGICA DEL SISTEMA DE REPETICIÓN ESPACIADA (SRS) ---
        const srsIntervals = [ 5 * 60 * 1000, 24 * 60 * 60 * 1000, 3 * 24 * 60 * 60 * 1000, 7 * 24 * 60 * 60 * 1000, 14 * 24 * 60 * 60 * 1000, 30 * 24 * 60 * 60 * 1000 ];
        
        async function updateWordProgress(wordId, wasCorrect) {
            if (!currentUser) return;
            const { data: progress } = await dbClient.from('user_word_progress').select('srs_level').eq('user_id', currentUser.id).eq('word_id', wordId).single();
            let newSrsLevel = progress ? progress.srs_level : 0;
            newSrsLevel = wasCorrect ? newSrsLevel + 1 : 0; // Incrementa si es correcto, reinicia si no
            const interval = srsIntervals[Math.min(newSrsLevel, srsIntervals.length - 1)];
            const next_review_at = new Date(Date.now() + interval).toISOString();
            const { error } = await dbClient.from('user_word_progress').upsert({ user_id: currentUser.id, word_id: wordId, srs_level: newSrsLevel, next_review_at: next_review_at }, { onConflict: 'user_id, word_id' });
            if (error) console.error("Error al actualizar progreso:", error);
            else if (wasCorrect) await updateUserPoints(5);
        }

        // --- 3. LÓGICA DE FLUJOS DE APRENDIZAJE (CONTROLADOR PRINCIPAL) ---
        async function iniciarFlujoDeAprendizaje() {
            if (!userProfile || !userProfile.flujo) {
                appContainer.innerHTML = `<h2 class="text-center font-bold">Error: No se encontró flujo de aprendizaje.</h2>`;
                return;
            }
            switch (userProfile.flujo.currentFlow) {
                case 1: await renderFlow1_Flashcards(); break;
                case 2: await renderFlow2_Practice(); break;
                case 3: await renderFlow3_Sentences(); break;
                // case 4: await renderFlow4_Conversation(); break;
                default: appContainer.innerHTML = `<h2 class="text-center font-bold">¡Has completado todos los flujos!</h2>`;
            }
        }

        async function renderFlow1_Flashcards() {
            const word = await getNextWordForReview();
            if (word) {
                currentWord = word;
                appContainer.innerHTML = getFlashcardHTML(word);
                addFlashcardEventListeners();
            } else {
                console.log("Flujo 1 completado. Avanzando a Flujo 2...");
                const newFlowState = userProfile.flujo;
                newFlowState.currentFlow = 2;
                newFlowState.flowState[newFlowState.currentGroup].flow1_flashcards.status = "completed";
                await updateUserFlowState(newFlowState);
                await renderFlow2_Practice();
            }
        }

        async function renderFlow2_Practice() {
            const flowState = userProfile.flujo.flowState[userProfile.flujo.currentGroup];
            if (!flowState.flow2_practice.queue || flowState.flow2_practice.queue.length === 0) {
                await generatePracticeQueue();
                await loadUserProfile();
            }
            const queue = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow2_practice.queue;
            const currentIndex = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow2_practice.currentIndex || 0;
            if (currentIndex >= queue.length) {
                console.log("Flujo 2 completado. Avanzando a Flujo 3...");
                const newFlowState = userProfile.flujo;
                newFlowState.currentFlow = 3;
                newFlowState.flowState[newFlowState.currentGroup].flow2_practice.status = "completed";
                await updateUserFlowState(newFlowState);
                await renderFlow3_Sentences();
                return;
            }
            const exercise = queue[currentIndex];
            const { data: wordData, error } = await dbClient.from('palabras').select('*').eq('id', exercise.word_id).single();
            if (error) { console.error("No se pudo cargar la palabra:", error); return; }
            currentWord = wordData;
            switch (exercise.type) {
                case 'select_word_by_image': await renderSelectWordByImageExercise(wordData, exercise.options); break;
                case 'write_word_by_audio': renderWriteWordByAudioExercise(wordData); break;
                default: await advanceInQueue();
            }
        }
        
        async function renderFlow3_Sentences() {
            const flowState = userProfile.flujo.flowState[userProfile.flujo.currentGroup];
            if (!flowState.flow3_sentences.queue || flowState.flow3_sentences.queue.length === 0) {
                await generateSentenceQueue();
                await loadUserProfile();
            }
            const queue = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow3_sentences.queue;
            const currentIndex = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow3_sentences.currentIndex || 0;
            if (currentIndex >= queue.length) {
                appContainer.innerHTML = `<h2 class="text-2xl font-bold font-heading text-center">¡Genial! ¡Terminaste las frases!</h2><p class="text-center">Próximamente: ¡Conversación con IA!</p>`;
                // Aquí avanzarías al Flujo 4
                return;
            }
            const exercise = queue[currentIndex];
            switch (exercise.type) {
                case 'dialogo_video': renderVideoDialogueExercise(exercise.data); break;
                case 'organizar_frase': renderSentenceScrambleExercise(exercise.data); break;
                case 'escribir_frase': renderSentenceDictationExercise(exercise.data); break;
                default: await advanceInSentenceQueue();
            }
        }

        // --- 4. RENDERIZADO DE EJERCICIOS Y COMPONENTES ---
        function getFlashcardHTML(word) {
            return `
                <div id="flashcard-container" class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center card-loading">
                <img id="card-image" src="${word.imagen || `https://via.placeholder.com/400/200/e6f0ff/0d47a1?text=${word.ingles}`}" alt="Imagen de la palabra" class="rounded-lg mb-2 w-full object-cover h-48">
                <h1 id="card-english" class="text-5xl font-bold font-heading mb-1">${word.ingles}</h1>
                <p id="card-spanish" class="text-2xl text-slate-500 opacity-75 mb-2">${word.espanol}</p>
                <p id="card-phonetic" class="text-xl font-mono text-[#FF7A00] mb-2 hidden">${word.fonetica || ''}</p>

                <div class="flex justify-center space-x-4 mb-4">
                    <button id="pronounce-btn" class="flex-1 bg-blue-100 text-[#0D47A1] font-semibold py-3 rounded-lg hover:bg-blue-200 transition flex items-center justify-center space-x-2">
                        <i class="fas fa-comment-dots"></i>
                        <span>Pronunciación</span>
                    </button>
                    <button id="sound-btn" class="flex-1 bg-blue-100 text-[#0D47A1] font-semibold py-3 rounded-lg hover:bg-blue-200 transition flex items-center justify-center space-x-2">
                        <i class="fas fa-play"></i>
                        <span>Sonido</span>
                    </button>
                </div>

                <div class="flex space-x-4">
                    <button id="btn-easy" class="w-1/2 py-3 rounded-lg font-bold transition text-green-800 bg-green-100 hover:bg-green-200" style="background-color: #C8E6C9; color: #2E7D32;">Fácil</button>
                    <button id="btn-hard" class="w-1/2 py-3 rounded-lg font-bold transition text-red-800 bg-red-100 hover:bg-red-200" style="background-color: #FFCDD2; color: #C62828;">Difícil</button>
                </div>
            </div>`;
        }
        
        async function renderSelectWordByImageExercise(correctWord, options) {
            let optionsHTML = options.sort(() => Math.random() - 0.5).map(option => `<button class="option-button w-full text-lg" data-word="${option}">${option}</button>`).join('');
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Selecciona la palabra correcta</h2>
                    <img src="${correctWord.imagen}" alt="Imagen" class="rounded-lg mb-6 w-full object-cover h-48">
                    <div class="grid grid-cols-2 gap-4">${optionsHTML}</div>
                </div>`;
            document.querySelectorAll('.option-button').forEach(button => button.addEventListener('click', async (e) => {
                const isCorrect = e.target.dataset.word === correctWord.ingles;
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.word === correctWord.ingles) btn.classList.add('correct');
                    else if (btn === e.target) btn.classList.add('incorrect');
                });
                await updateWordProgress(correctWord.id, isCorrect);
                setTimeout(advanceInQueue, 2000);
            }));
        }
        
        function renderWriteWordByAudioExercise(word) {
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Escribe lo que escuches</h2>
                    <button id="play-audio-btn" class="mb-6 bg-blue-500 text-white rounded-full h-20 w-20 flex items-center justify-center mx-auto text-3xl hover:bg-blue-600 transition"><i class="fas fa-volume-up"></i></button>
                    <input id="word-input" type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl" placeholder="Escribe aquí...">
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-4">Comprobar</button>
                    <div id="feedback" class="mt-4 h-10"></div>
                </div>`;
            const audio = new Audio(word.audio);
            document.getElementById('play-audio-btn').addEventListener('click', () => audio.play());
            document.getElementById('check-btn').addEventListener('click', async () => {
                const input = document.getElementById('word-input'), feedback = document.getElementById('feedback');
                const isCorrect = input.value.trim().toLowerCase() === word.ingles.toLowerCase();
                await updateWordProgress(word.id, isCorrect);
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold">¡Correcto!</p>` : `<p class="text-red-600 font-bold">Respuesta: <span class="font-mono">${word.ingles}</span></p>`;
                document.getElementById('check-btn').disabled = true;
                setTimeout(advanceInQueue, 2500);
            });
            audio.play();
        }

        function renderVideoDialogueExercise(videoData) {
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Mira y escucha</h2>
                    <video controls class="w-full rounded-lg mb-4" src="${videoData.video}"></video>
                    <div class="text-left space-y-2 p-4 bg-gray-50 rounded-lg">
                        <p><strong class="text-blue-600">EN:</strong> ${videoData.textoingles.replace(/\n/g, '<br>')}</p>
                        <p><strong class="text-orange-600">ES:</strong> ${videoData.textoespañol.replace(/\n/g, '<br>')}</p>
                    </div>
                    <button id="next-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-6">Continuar</button>
                </div>`;
            document.getElementById('next-btn').addEventListener('click', advanceInSentenceQueue);
        }

        function renderSentenceScrambleExercise(phraseData) {
            const words = phraseData.fraseingles.split(' ').sort(() => Math.random() - 0.5);
            let wordButtonsHTML = words.map(word => `<span class="scramble-word">${word}</span>`).join('');
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl">
                    <h2 class="text-xl font-bold font-heading mb-2 text-center">Organiza la frase</h2>
                    <p class="text-center text-slate-500 mb-4">Traducción: "${phraseData.fraseespañol}"</p>
                    <div id="answer-area" class="answer-area flex flex-wrap items-center mb-4"></div>
                    <div id="word-bank" class="flex flex-wrap justify-center items-center mb-4">${wordButtonsHTML}</div>
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold">Comprobar</button>
                    <div id="feedback" class="mt-4 h-8 text-center font-bold"></div>
                </div>`;
            const wordBank = document.getElementById('word-bank'), answerArea = document.getElementById('answer-area');
            const moveWord = (e) => {
                if(e.target.classList.contains('scramble-word')) {
                    const destination = e.currentTarget.id === 'word-bank' ? answerArea : wordBank;
                    destination.appendChild(e.target);
                }
            };
            wordBank.addEventListener('click', moveWord);
            answerArea.addEventListener('click', moveWord);
            document.getElementById('check-btn').addEventListener('click', async () => {
                const constructed = [...answerArea.children].map(el => el.textContent).join(' ');
                const isCorrect = constructed === phraseData.fraseingles;
                const feedback = document.getElementById('feedback');
                feedback.className = `mt-4 h-8 text-center font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}`;
                feedback.textContent = isCorrect ? '¡Correcto!' : 'Inténtalo de nuevo.';
                if (isCorrect) {
                    await updateUserPoints(10);
                    document.getElementById('check-btn').disabled = true;
                    setTimeout(advanceInSentenceQueue, 1500);
                }
            });
        }

        function renderSentenceDictationExercise(audioData) {
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Escribe lo que escuches</h2>
                    <button id="play-audio-btn" class="mb-6 bg-blue-500 text-white rounded-full h-20 w-20 flex items-center justify-center mx-auto text-3xl hover:bg-blue-600 transition"><i class="fas fa-volume-up"></i></button>
                    <input id="sentence-input" type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl" placeholder="Escribe la frase...">
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-4">Comprobar</button>
                    <div id="feedback" class="mt-4 h-10"></div>
                </div>`;
            const audio = new Audio(audioData.audio);
            document.getElementById('play-audio-btn').addEventListener('click', () => audio.play());
            document.getElementById('check-btn').addEventListener('click', async () => {
                const input = document.getElementById('sentence-input'), feedback = document.getElementById('feedback');
                const cleanInput = input.value.trim().replace(/[.,!?]/g, '').toLowerCase();
                const cleanAnswer = audioData.fraseingles.replace(/[.,!?]/g, '').toLowerCase();
                const isCorrect = cleanInput === cleanAnswer;
                if (isCorrect) {
                    feedback.innerHTML = `<p class="text-green-600 font-bold">¡Perfecto!</p>`;
                    await updateUserPoints(15);
                    document.getElementById('check-btn').disabled = true;
                    setTimeout(advanceInSentenceQueue, 2000);
                } else {
                    feedback.innerHTML = `<p class="text-red-600 font-bold">Correcto: <span class="block mt-1">${audioData.fraseingles}</span></p>`;
                }
            });
            audio.play();
        }

        // --- 5. FUNCIONES AUXILIARES ---
        async function getNextWordForReview() {
            const now = new Date().toISOString(), group = userProfile.flujo.currentGroup;
            const { data: review } = await dbClient.from('user_word_progress').select(`srs_level, palabras!inner(*)`).eq('user_id', currentUser.id).eq('palabras.grupo', group).lte('next_review_at', now).order('next_review_at').limit(1).single();
            if (review) return { ...review.palabras, srs_level: review.srs_level };
            const { data: seen } = await dbClient.from('user_word_progress').select('word_id').eq('user_id', currentUser.id);
            const seenIds = seen ? seen.map(w => w.word_id) : [];
            let query = dbClient.from('palabras').select('*').eq('grupo', group);
            if (seenIds.length > 0) query = query.not('id', 'in', `(${seenIds.join(',')})`);
            const { data: newWord } = await query.order('id').limit(1).single();
            return newWord ? { ...newWord, srs_level: 0 } : null;
        }

        async function generatePracticeQueue() {
            const group = userProfile.flujo.currentGroup;
            const { data: words } = await dbClient.from('palabras').select('id, ingles').eq('grupo', group);
            if (!words) return;
            const types = ['select_word_by_image', 'write_word_by_audio'];
            let queue = words.map(word => {
                const type = types[Math.floor(Math.random() * types.length)];
                let exercise = { type, word_id: word.id };
                if (type === 'select_word_by_image') {
                    let options = [word.ingles];
                    let others = words.filter(w => w.id !== word.id).sort(() => .5 - Math.random()).slice(0, 3);
                    options.push(...others.map(w => w.ingles));
                    exercise.options = options;
                }
                return exercise;
            }).sort(() => Math.random() - 0.5);
            const newFlow = userProfile.flujo;
            newFlow.flowState[group].flow2_practice = { status: "in_progress", queue, currentIndex: 0 };
            await updateUserFlowState(newFlow);
        }

        async function generateSentenceQueue() {
            const group = userProfile.flujo.currentGroup;
            const { data: frases } = await dbClient.from('frases').select('*').eq('grupo', group);
            const { data: audios } = await dbClient.from('audios').select('*').eq('grupo', group);
            const { data: videos } = await dbClient.from('videos').select('*').eq('grupo', group);
            let queue = [];
            if (videos) videos.forEach(v => queue.push({ type: 'dialogo_video', data: v }));
            if (frases) frases.forEach(f => queue.push({ type: 'organizar_frase', data: f }));
            if (audios) audios.forEach(a => queue.push({ type: 'escribir_frase', data: a }));
            queue.sort(() => Math.random() - 0.5);
            const newFlow = userProfile.flujo;
            newFlow.flowState[group].flow3_sentences = { status: "in_progress", queue, currentIndex: 0 };
            await updateUserFlowState(newFlow);
        }

        async function advanceInQueue() {
            const flow = userProfile.flujo;
            flow.flowState[flow.currentGroup].flow2_practice.currentIndex++;
            await updateUserFlowState(flow);
            await renderFlow2_Practice();
        }

        async function advanceInSentenceQueue() {
            const flow = userProfile.flujo;
            flow.flowState[flow.currentGroup].flow3_sentences.currentIndex++;
            await updateUserFlowState(flow);
            await renderFlow3_Sentences();
        }

        function addFlashcardEventListeners() {
            document.getElementById('pronounce-btn').addEventListener('click', () => {
                document.getElementById('card-phonetic').classList.toggle('hidden');
                if (currentWord && currentWord.audio) new Audio(currentWord.audio).play();
            });
            const handleResponse = async (isEasy) => {
                await updateWordProgress(currentWord.id, isEasy);
                await renderFlow1_Flashcards();
            };
            document.getElementById('btn-easy').addEventListener('click', () => handleResponse(true));
            document.getElementById('btn-hard').addEventListener('click', () => handleResponse(false));
        }

        async function loadUserProfile() {
            const { data, error } = await dbClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if (error) console.error("Error al cargar perfil:", error);
            userProfile = data;
        }

        async function updateUserFlowState(newFlowState) {
            const { error } = await dbClient.from('profiles').update({ flujo: newFlowState }).eq('id', currentUser.id);
            if (error) console.error("Error al actualizar flujo:", error);
            else userProfile.flujo = newFlowState;
        }

        async function updateUserPoints(pointsToAdd) {
             const newPoints = (userProfile.points || 0) + pointsToAdd;
             await dbClient.from('profiles').update({ points: newPoints }).eq('id', currentUser.id);
             userProfile.points = newPoints;
             document.getElementById('user-points').textContent = newPoints;
        }

        // --- 6. EJECUCIÓN INICIAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await dbClient.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            currentUser = session.user;
            await loadUserProfile();
            if (userProfile) {
                document.getElementById('user-name-nav').textContent = userProfile.full_name || 'Mi Perfil';
                document.getElementById('user-name-dropdown').textContent = userProfile.full_name || 'Sin nombre';
                document.getElementById('user-email-dropdown').textContent = currentUser.email;
                document.getElementById('user-points').textContent = userProfile.points || 0;
                document.getElementById('user-lingots').textContent = userProfile.lingots || '0.00';
                await iniciarFlujoDeAprendizaje();
            }
            const menuButton = document.getElementById('menu-button'), mobileMenu = document.getElementById('mobile-menu');
            const profileMenuButton = document.getElementById('profile-menu-button'), profileMenuDropdown = document.getElementById('profile-menu-dropdown');
            menuButton.addEventListener('click', e => { e.stopPropagation(); mobileMenu.classList.toggle('hidden'); });
            profileMenuButton.addEventListener('click', e => { e.stopPropagation(); profileMenuDropdown.classList.toggle('hidden'); });
            document.addEventListener('click', e => {
                if (!mobileMenu.contains(e.target) && !menuButton.contains(e.target)) mobileMenu.classList.add('hidden');
                if (!profileMenuDropdown.contains(e.target) && !profileMenuButton.contains(e.target)) profileMenuDropdown.classList.add('hidden');
            });
            document.getElementById('logout-btn').addEventListener('click', async () => {
                await dbClient.auth.signOut();
                window.location.href = 'index.html';
            });
        });
    </script>
    <script src="js/igual1.js"></script> 
</body>
</html>
=======
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abulingo - Aprende Inglés</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&family=Work+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"></link>
    <link rel="stylesheet" href="style.css">   
</head>
<body class="min-h-screen">

    <div id="navBarra">
        <nav class="fixed top-0 left-0 right-0 bg-white shadow-md z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <h1 class="text-2xl font-bold">Abulingo</h1>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <button id="ranking-global-btn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Ranking Global</button>
                            <button id="ranking-equipo-btn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Ranking Equipo</button>
                            <button id="nivel-btn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Nivel</button>
                            <button id="progreso-nivel-btn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Progreso Nivel</button>
                            <button id="mazo-btn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Mazo</button>
                            <button id="cambiar-pass-btn" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Cambiar Contraseña</button>
                            <span id="user-points" class="text-gray-700 px-3 py-2 rounded-md text-sm font-medium">0</span>
                        </div>
                    </div>
                    <div class="hidden md:block">
                        <button id="profile-menu-button" class="flex items-center text-gray-700 hover:text-blue-600">
                            <span id="user-name-nav">Mi Perfil</span>
                            <i class="fas fa-chevron-down ml-2"></i>
                        </button>
                        <div id="profile-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1">
                            <p id="user-name-dropdown" class="px-4 py-2 text-sm text-gray-700"></p>
                            <p id="user-email-dropdown" class="px-4 py-2 text-sm text-gray-700"></p>
                            <p class="px-4 py-2 text-sm text-gray-700">Lingots: <span id="user-lingots">0.00</span></p>
                            <button id="logout-btn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Cerrar Sesión</button>
                        </div>
                    </div>
                    <div class="-mr-2 flex md:hidden">
                        <button id="menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-blue-600 hover:bg-gray-100 focus:outline-none">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <button id="ranking-global-btn-mobile" class="block w-full text-left text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium">Ranking Global</button>
                    <button id="ranking-equipo-btn-mobile" class="block w-full text-left text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium">Ranking Equipo</button>
                    <button id="nivel-btn-mobile" class="block w-full text-left text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium">Nivel</button>
                    <button id="progreso-nivel-btn-mobile" class="block w-full text-left text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium">Progreso Nivel</button>
                    <button id="mazo-btn-mobile" class="block w-full text-left text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium">Mazo</button>
                    <button id="cambiar-pass-btn-mobile" class="block w-full text-left text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium">Cambiar Contraseña</button>
                    <span class="block px-3 py-2 text-base font-medium text-gray-700">Puntos: <span id="user-points-mobile">0</span></span>
                </div>
            </div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-ranking-global" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Ranking Global</h2>
            <ul id="global-ranking-list" class="space-y-2"></ul>
            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-ranking-global">Cerrar</button>
        </div>
    </div>

    <div id="modal-ranking-equipo" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Ranking Equipo</h2>
            <ul id="equipo-ranking-list" class="space-y-2"></ul>
            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-ranking-equipo">Cerrar</button>
        </div>
    </div>

    <div id="modal-nivel" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Tu Nivel</h2>
            <p id="user-level"></p>
            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-nivel">Cerrar</button>
        </div>
    </div>

    <div id="modal-progreso-nivel" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Progreso de Nivel</h2>
            <p id="user-progress"></p>
            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-progreso-nivel">Cerrar</button>
        </div>
    </div>

    <div id="modal-mazo" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Tu Mazo</h2>
            <ul id="mazo-list" class="space-y-2"></ul>
            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-mazo">Cerrar</button>
        </div>
    </div>

    <div id="modal-cambiar-pass" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Cambiar Contraseña</h2>
            <input id="new-pass" type="password" placeholder="Nueva Contraseña" class="w-full border p-2 mb-2">
            <input id="confirm-pass" type="password" placeholder="Confirmar Contraseña" class="w-full border p-2 mb-4">
            <button id="update-pass-btn" class="bg-blue-500 text-white py-2 px-4 rounded">Actualizar</button>
            <button class="mt-2 bg-gray-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-cambiar-pass">Cancelar</button>
        </div>
    </div>

    <div id="modal-advice" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full text-center">
            <h2 class="text-xl font-bold mb-4">Consejos Iniciales</h2>
            <p class="mb-2">Se recomienda que mientras escuches la pronunciación de la palabra, la pronuncies también.</p>
            <p>No estudies solo si estás en lo correcto; de lo contrario, será inefectivo nuestro método para ti.</p>
            <button class="mt-4 bg-blue-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-advice">Entendido</button>
        </div>
    </div>

    <div id="modal-api-key" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">Ingresa tu API Key de Gemini</h2>
            <input id="api-key-input" type="text" placeholder="API Key" class="w-full border p-2 mb-4">
            <button id="save-api-key-btn" class="bg-blue-500 text-white py-2 px-4 rounded">Guardar</button>
            <button class="mt-2 bg-gray-500 text-white py-2 px-4 rounded close-modal" data-modal="modal-api-key">Cancelar</button>
        </div>
    </div>

    <main class="pt-24 pb-12 flex flex-col items-center justify-center min-h-screen">
        <div id="app-container" class="w-full max-w-2xl mx-auto px-4">
            <div class="text-center"><h1 class="text-3xl font-bold font-heading">Cargando tu aventura...</h1><p class="text-slate-600">Por favor, espera un momento.</p></div>
        </div>
    </main>

    <script type="module">
        const SUPABASE_URL = 'https://zdybpplggppjrmxhfhik.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpkeWJwcGxnZ3BwanJteGhmaGlrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODY0MTcsImV4cCI6MjA3NDc2MjQxN30._1LRLhgIsNnc48Tj431F7xRWwHma0WCkc613ztmpjtU'

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) alert("¡Error! Debes configurar tus credenciales de Supabase.");

        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null, userProfile = null, currentWord = null;
        const appContainer = document.getElementById('app-container');
        const initialFlowJson = {
          "version": 1,
          "flowState": {
            "G1": {
              "flow1_flashcards": {
                "status": "not_started",
                "lastWordId": null,
                "completedCount": 0
              },
              "flow2_practice": {
                "queue": [],
                "status": "not_started",
                "currentIndex": 0
              },
              "flow3_sentences": {
                "queue": [],
                "status": "not_started",
                "currentIndex": 0
              },
              "flow4_conversation": {
                "status": "not_started"
              }
            },
            "G2": {
              "flow1_flashcards": {
                "status": "not_started",
                "lastWordId": null,
                "completedCount": 0
              },
              "flow2_practice": {
                "queue": [],
                "status": "not_started",
                "currentIndex": 0
              },
              "flow3_sentences": {
                "queue": [],
                "status": "not_started",
                "currentIndex": 0
              },
              "flow4_conversation": {
                "status": "not_started"
              }
            }
          },
          "currentFlow": 1,
          "currentGroup": "G1"
        };

        // --- Modal Functions ---
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('hidden');
        }
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        }
        window.closeModal = closeModal;  // Expose to global for onclick

        // --- 2. LÓGICA DEL SISTEMA DE REPETICIÓN ESPACIADA (SRS) ---
        const srsIntervals = [ 5 * 60 * 1000, 24 * 60 * 60 * 1000, 3 * 24 * 60 * 60 * 1000, 7 * 24 * 60 * 60 * 1000, 14 * 24 * 60 * 60 * 1000, 30 * 24 * 60 * 60 * 1000 ];
        
        async function updateWordProgress(wordId, wasCorrect) {
            if (!currentUser) return;
            const { data: progress, error: progressError } = await dbClient.from('user_word_progress').select('srs_level').eq('user_id', currentUser.id).eq('word_id', wordId).single();
            if (progressError && progressError.code !== 'PGRST116') {
                console.error("Error al obtener progreso:", progressError);
                return;
            }
            let newSrsLevel = progress ? progress.srs_level : 0;
            newSrsLevel = wasCorrect ? newSrsLevel + 1 : 0;
            const interval = srsIntervals[Math.min(newSrsLevel, srsIntervals.length - 1)];
            const next_review_at = new Date(Date.now() + interval).toISOString();
            const { error } = await dbClient.from('user_word_progress').upsert({ user_id: currentUser.id, word_id: wordId, srs_level: newSrsLevel, next_review_at: next_review_at }, { onConflict: 'user_id,word_id' });
            if (error) console.error("Error al actualizar progreso:", error);
            else if (wasCorrect) await updateUserPoints(5);
        }

        // --- 3. LÓGICA DE FLUJOS DE APRENDIZAJE (CONTROLADOR PRINCIPAL) ---
        async function iniciarFlujoDeAprendizaje() {
            try {
                if (!userProfile) return;
                if (!userProfile.flujo) {
                    await dbClient.from('profiles').update({ flujo: initialFlowJson }).eq('id', currentUser.id);
                    await loadUserProfile();
                }
                if (userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow1_flashcards.status === "not_started") {
                    showModal('modal-advice');
                }
                switch (userProfile.flujo.currentFlow) {
                    case 1: await renderFlow1_Flashcards(); break;
                    case 2: await renderFlow2_Practice(); break;
                    case 3: await renderFlow3_Sentences(); break;
                    case 4: await renderFlow4_Conversation(); break;
                    default: 
                        // Advance to next group if available
                        if (userProfile.flujo.currentGroup === "G1") {
                            userProfile.flujo.currentGroup = "G2";
                            userProfile.flujo.currentFlow = 1;
                            await updateUserFlowState(userProfile.flujo);
                            await iniciarFlujoDeAprendizaje();
                        } else {
                            appContainer.innerHTML = `<h2 class="text-center font-bold">¡Has completado todos los flujos!</h2>`;
                        }
                }
            } catch (err) {
                console.error("Error en flujo de aprendizaje:", err);
                appContainer.innerHTML = `<h2 class="text-center font-bold text-red-600">Error al cargar el contenido. Por favor, recarga la página.</h2>`;
            }
        }

        async function renderFlow1_Flashcards() {
            const word = await getNextWordForReview();
            if (word) {
                currentWord = word;
                appContainer.innerHTML = getFlashcardHTML(word);
                addFlashcardEventListeners();
            } else {
                console.log("Flujo 1 completado temporalmente. Avanzando a Flujo 2...");
                const newFlowState = userProfile.flujo;
                newFlowState.currentFlow = 2;
                newFlowState.flowState[newFlowState.currentGroup].flow1_flashcards.status = "in_progress"; // No completado permanente para repeats
                await updateUserFlowState(newFlowState);
                await renderFlow2_Practice();
            }
        }

        async function renderFlow2_Practice() {
            const flowState = userProfile.flujo.flowState[userProfile.flujo.currentGroup];
            if (!flowState.flow2_practice.queue || flowState.flow2_practice.queue.length === 0) {
                await generatePracticeQueue();
                await loadUserProfile();
            }
            const queue = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow2_practice.queue;
            const currentIndex = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow2_practice.currentIndex || 0;
            if (currentIndex >= queue.length) {
                // Check if there are pending reviews for flow1
                const pendingWord = await getNextWordForReview();
                if (pendingWord) {
                    console.log("Reviews pendientes. Regresando a Flujo 1...");
                    const newFlowState = userProfile.flujo;
                    newFlowState.currentFlow = 1;
                    await updateUserFlowState(newFlowState);
                    await renderFlow1_Flashcards();
                } else {
                    console.log("Flujo 2 completado. Avanzando a Flujo 3...");
                    const newFlowState = userProfile.flujo;
                    newFlowState.currentFlow = 3;
                    newFlowState.flowState[newFlowState.currentGroup].flow2_practice.status = "completed";
                    await updateUserFlowState(newFlowState);
                    await renderFlow3_Sentences();
                }
                return;
            }
            const exercise = queue[currentIndex];
            const { data: wordData, error } = await dbClient.from('palabras').select('*').eq('id', exercise.word_id).single();
            if (error) { console.error("No se pudo cargar la palabra:", error); return; }
            currentWord = wordData;
            switch (exercise.type) {
                case 'select_image_by_audio': await renderSelectImageByAudioExercise(wordData, exercise.options); break;
                case 'select_word_by_image': await renderSelectWordByImageExercise(wordData, exercise.options); break;
                case 'write_word_by_image': renderWriteWordByImageExercise(wordData); break;
                case 'write_word_by_audio': renderWriteWordByAudioExercise(wordData); break;
                default: await advanceInQueue();
            }
        }
        
        async function renderFlow3_Sentences() {
            const flowState = userProfile.flujo.flowState[userProfile.flujo.currentGroup];
            if (!flowState.flow3_sentences.queue || flowState.flow3_sentences.queue.length === 0) {
                await generateSentenceQueue();
                await loadUserProfile();
            }
            const queue = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow3_sentences.queue;
            const currentIndex = userProfile.flujo.flowState[userProfile.flujo.currentGroup].flow3_sentences.currentIndex || 0;
            if (currentIndex >= queue.length) {
                console.log("Flujo 3 completado. Avanzando a Flujo 4...");
                const newFlowState = userProfile.flujo;
                newFlowState.currentFlow = 4;
                newFlowState.flowState[newFlowState.currentGroup].flow3_sentences.status = "completed";
                await updateUserFlowState(newFlowState);
                await renderFlow4_Conversation();
                return;
            }
            const exercise = queue[currentIndex];
            switch (exercise.type) {
                case 'dialogo_video': renderVideoDialogueExercise(exercise.data); break;
                case 'organizar_frase': renderSentenceScrambleExercise(exercise.data); break;
                case 'escribir_frase': renderSentenceDictationExercise(exercise.data); break;
                default: await advanceInSentenceQueue();
            }
        }

        async function renderFlow4_Conversation() {
            if (!userProfile.api_key) {
                //showModal('modal-api-key');  HACKEE
                return;
            }
            const flowState = userProfile.flujo.flowState[userProfile.flujo.currentGroup];
            if (flowState.flow4_conversation.status === "completed") {
                appContainer.innerHTML = `<h2 class="text-2xl font-bold font-heading text-center">¡Conversación completada!</h2>`;
                return;
            }
            // Simple chat interface
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl">
                    <h2 class="text-2xl font-bold font-heading mb-4 text-center">Conversación con IA</h2>
                    <div id="chat-history" class="h-64 overflow-y-auto bg-gray-50 p-4 rounded-lg mb-4"></div>
                    <input id="chat-input" type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 mb-4" placeholder="Escribe tu mensaje...">
                    <button id="send-chat-btn" class="w-full btn-primary py-3 rounded-lg font-bold">Enviar</button>
                    <button id="end-conversation-btn" class="w-full bg-red-500 text-white py-3 rounded-lg font-bold mt-4">Terminar Conversación</button>
                </div>`;
            const chatHistory = document.getElementById('chat-history');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-chat-btn');
            let history = [{ role: "system", content: "You are an English teacher. Correct the user's English and continue the conversation in a friendly way." }];

            sendBtn.addEventListener('click', async () => {
                const message = chatInput.value.trim();
                if (!message) return;
                chatHistory.innerHTML += `<p class="text-right bg-blue-100 p-2 rounded mb-2">${message}</p>`;
                history.push({ role: "user", content: message });
                chatInput.value = '';
                const system = history[0].content;
                const contents = history.slice(1).map(msg => ({
                    role: msg.role === 'assistant' ? 'model' : 'user',
                    parts: [{ text: msg.content }]
                }));
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${userProfile.api_key}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        system_instruction: { parts: [{ text: system }] },
                        contents
                    })
                });
                const data = await response.json();
                const aiMessage = data.candidates[0].content.parts[0].text;
                chatHistory.innerHTML += `<p class="text-left bg-green-100 p-2 rounded mb-2">${aiMessage}</p>`;
                history.push({ role: "assistant", content: aiMessage });
                chatHistory.scrollTop = chatHistory.scrollHeight;
            });

            document.getElementById('end-conversation-btn').addEventListener('click', async () => {
                const newFlowState = userProfile.flujo;
                newFlowState.flowState[newFlowState.currentGroup].flow4_conversation.status = "completed";
                await updateUserFlowState(newFlowState);
                await iniciarFlujoDeAprendizaje();
            });
        }

        // --- 4. RENDERIZADO DE EJERCICIOS Y COMPONENTES ---
        function getFlashcardHTML(word) {
            return `
                <div id="flashcard-container" class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center card-loading">
                <img id="card-image" loading="lazy" src="${word.imagen || `https://via.placeholder.com/400/200/e6f0ff/0d47a1?text=${word.ingles}`}" alt="Imagen de la palabra" class="rounded-lg mb-2 w-full object-cover h-48">
                <h1 id="card-english" class="text-5xl font-bold font-heading mb-1">${word.ingles.toLowerCase()}</h1>
                <p id="card-spanish" class="text-xl text-slate-500 opacity-50 mb-2">${word.espanol}</p>
                <p id="card-phonetic" class="text-xl font-mono text-[#FF7A00] mb-2 hidden">${word.fonetica || ''}</p>

                <div class="flex justify-center space-x-4 mb-4">
                    <button id="pronounce-btn" class="flex-1 bg-blue-100 text-[#0D47A1] font-semibold py-3 rounded-lg hover:bg-blue-200 transition flex items-center justify-center space-x-2" ${word.audio ? '' : 'disabled'}>
                        <i class="fas fa-comment-dots"></i>
                        <span>Pronunciación</span>
                    </button>
                    <button id="sound-btn" class="flex-1 bg-blue-100 text-[#0D47A1] font-semibold py-3 rounded-lg hover:bg-blue-200 transition flex items-center justify-center space-x-2" ${word.audio ? '' : 'disabled'}>
                        <i class="fas fa-play"></i>
                        <span>Sonido</span>
                    </button>
                </div>

                <div class="flex space-x-4">
                    <button id="btn-easy" class="w-1/2 py-3 rounded-lg font-bold transition text-green-800 bg-green-100 hover:bg-green-200" style="background-color: #C8E6C9; color: #2E7D32;">Fácil</button>
                    <button id="btn-hard" class="w-1/2 py-3 rounded-lg font-bold transition text-red-800 bg-red-100 hover:bg-red-200" style="background-color: #FFCDD2; color: #C62828;">Difícil</button>
                </div>
            </div>`;
        }
        
        async function renderSelectImageByAudioExercise(correctWord, options) {
            if (!correctWord.audio) {
                console.error("No audio available for this word.");
                await advanceInQueue();
                return;
            }
            let optionsHTML = options.sort(() => Math.random() - 0.5).map(option => `<img loading="lazy" class="option-image w-full h-32 object-cover rounded-lg cursor-pointer" src="${option}" data-src="${option}">`).join('');
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Selecciona la imagen correcta</h2>
                    <button id="play-audio-btn" class="mb-6 bg-blue-500 text-white rounded-full h-20 w-20 flex items-center justify-center mx-auto text-3xl hover:bg-blue-600 transition"><i class="fas fa-volume-up"></i></button>
                    <div class="grid grid-cols-2 gap-4">${optionsHTML}</div>
                    <div id="feedback" class="mt-4 h-10"></div>
                    <button id="continue-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-bold mt-4 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            const audio = new Audio(correctWord.audio);
            document.getElementById('play-audio-btn').addEventListener('click', () => audio.play().catch(err => console.error("Error playing audio:", err)));
            audio.play().catch(err => console.error("Error playing audio:", err));
            document.querySelectorAll('.option-image').forEach(img => img.addEventListener('click', async (e) => {
                const isCorrect = e.target.src === correctWord.imagen;
                const feedback = document.getElementById('feedback');
                document.querySelectorAll('.option-image').forEach(i => {
                    i.style.pointerEvents = 'none';
                    if (i.src === correctWord.imagen) i.classList.add('border-4', 'border-green-500');
                    else if (i === e.target) i.classList.add('border-4', 'border-red-500');
                });
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold">¡Correcto!</p>` : `<p class="text-red-600 font-bold">Incorrecto</p>`;
                await updateWordProgress(correctWord.id, isCorrect);
                if (isCorrect) {
                    setTimeout(advanceInQueue, 2000);
                } else {
                    document.getElementById('continue-btn').classList.remove('hidden');
                    document.getElementById('continue-btn').addEventListener('click', advanceInQueue);
                }
            }));
        }
        
        async function renderSelectWordByImageExercise(correctWord, options) {
            let optionsHTML = options.sort(() => Math.random() - 0.5).map(option => `<button class="option-button w-full text-lg" data-word="${option}">${option.toLowerCase()}</button>`).join('');
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Selecciona la palabra correcta</h2>
                    <img loading="lazy" src="${correctWord.imagen}" alt="Imagen" class="rounded-lg mb-6 w-full object-cover h-48">
                    <div class="grid grid-cols-2 gap-4">${optionsHTML}</div>
                    <div id="feedback" class="mt-4 h-10"></div>
                    <button id="continue-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-bold mt-4 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            document.querySelectorAll('.option-button').forEach(button => button.addEventListener('click', async (e) => {
                const isCorrect = e.target.dataset.word === correctWord.ingles;
                const feedback = document.getElementById('feedback');
                document.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.word === correctWord.ingles) btn.classList.add('bg-green-200');
                    else if (btn === e.target) btn.classList.add('bg-red-200');
                });
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold">¡Correcto!</p>` : `<p class="text-red-600 font-bold">Incorrecto. Correcto: ${correctWord.ingles}</p>`;
                await updateWordProgress(correctWord.id, isCorrect);
                if (isCorrect) {
                    setTimeout(advanceInQueue, 2000);
                } else {
                    document.getElementById('continue-btn').classList.remove('hidden');
                    document.getElementById('continue-btn').addEventListener('click', advanceInQueue);
                }
            }));
        }
        
        function renderWriteWordByImageExercise(word) {
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Escribe la palabra según la imagen</h2>
                    <img loading="lazy" src="${word.imagen}" alt="Imagen" class="rounded-lg mb-6 w-full object-cover h-48">
                    <input id="word-input" type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl" placeholder="Escribe aquí...">
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-4">Comprobar</button>
                    <div id="feedback" class="mt-4 h-10"></div>
                    <button id="continue-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-bold mt-4 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            document.getElementById('check-btn').addEventListener('click', async () => {
                const input = document.getElementById('word-input'), feedback = document.getElementById('feedback');
                const isCorrect = input.value.trim().toLowerCase() === word.ingles.toLowerCase();
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold">¡Correcto!</p>` : `<p class="text-red-600 font-bold">Respuesta: <span class="font-mono">${word.ingles}</span></p>`;
                await updateWordProgress(word.id, isCorrect);
                document.getElementById('check-btn').disabled = true;
                if (isCorrect) {
                    setTimeout(advanceInQueue, 2000);
                } else {
                    document.getElementById('continue-btn').classList.remove('hidden');
                    document.getElementById('continue-btn').addEventListener('click', advanceInQueue);
                }
            });
        }

        function renderWriteWordByAudioExercise(word) {
            if (!word.audio) {
                console.error("No audio available for this word.");
                advanceInQueue();
                return;
            }
            appContainer.innerHTML = `
                <div class="card-style w-full max-w-md mx-auto p-8 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Escribe lo que escuches</h2>
                    <button id="play-audio-btn" class="mb-6 bg-blue-500 text-white rounded-full h-20 w-20 flex items-center justify-center mx-auto text-3xl hover:bg-blue-600 transition"><i class="fas fa-volume-up"></i></button>
                    <input id="word-input" type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl" placeholder="Escribe aquí...">
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-4">Comprobar</button>
                    <div id="feedback" class="mt-4 h-10"></div>
                    <button id="continue-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-bold mt-4 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            const audio = new Audio(word.audio);
            document.getElementById('play-audio-btn').addEventListener('click', () => audio.play().catch(err => console.error("Error playing audio:", err)));
            document.getElementById('check-btn').addEventListener('click', async () => {
                const input = document.getElementById('word-input'), feedback = document.getElementById('feedback');
                const isCorrect = input.value.trim().toLowerCase() === word.ingles.toLowerCase();
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold">¡Correcto!</p>` : `<p class="text-red-600 font-bold">Respuesta: <span class="font-mono">${word.ingles}</span></p>`;
                await updateWordProgress(word.id, isCorrect);
                document.getElementById('check-btn').disabled = true;
                if (isCorrect) {
                    setTimeout(advanceInQueue, 2000);
                } else {
                    document.getElementById('continue-btn').classList.remove('hidden');
                    document.getElementById('continue-btn').addEventListener('click', advanceInQueue);
                }
            });
            audio.play().catch(err => console.error("Error playing audio:", err));
        }

        function renderVideoDialogueExercise(videoData) {
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Mira y escucha</h2>
                    <video controls class="w-full rounded-lg mb-4" src="${videoData.video}"></video>
                    <div class="text-left space-y-2 p-4 bg-gray-50 rounded-lg">
                        <p><strong class="text-blue-600">EN:</strong> ${videoData.textoingles.replace(/\n/g, '<br>')}</p>
                        <p><strong class="text-orange-600">ES:</strong> ${videoData.textoespañol.replace(/\n/g, '<br>')}</p>
                    </div>
                    <button id="next-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-6 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            document.getElementById('next-btn').addEventListener('click', advanceInSentenceQueue);
        }

        function renderSentenceScrambleExercise(phraseData) {
            const words = phraseData.fraseingles.split(' ').sort(() => Math.random() - 0.5);
            let wordButtonsHTML = words.map(word => `<span class="scramble-word bg-blue-100 p-2 rounded cursor-pointer m-1">${word.toLowerCase()}</span>`).join('');
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl">
                    <h2 class="text-xl font-bold font-heading mb-2 text-center">Organiza la frase</h2>
                    <p class="text-center text-slate-500 mb-4">Traducción: "${phraseData.fraseespañol}"</p>
                    <div id="answer-area" class="answer-area flex flex-wrap items-center mb-4 min-h-[50px] border-2 border-dashed border-gray-300 rounded p-2"></div>
                    <div id="word-bank" class="flex flex-wrap justify-center items-center mb-4">${wordButtonsHTML}</div>
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold">Comprobar</button>
                    <div id="feedback" class="mt-4 h-8 text-center font-bold"></div>
                    <button id="continue-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-bold mt-4 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            const wordBank = document.getElementById('word-bank'), answerArea = document.getElementById('answer-area');
            const moveWord = (e) => {
                if (e.target.classList.contains('scramble-word')) {
                    const destination = e.currentTarget.id === 'word-bank' ? answerArea : wordBank;
                    destination.appendChild(e.target);
                }
            };
            wordBank.addEventListener('click', moveWord);
            answerArea.addEventListener('click', moveWord);
            document.getElementById('check-btn').addEventListener('click', async () => {
                const constructed = [...answerArea.children].map(el => el.textContent).join(' ');
                const isCorrect = constructed.toLowerCase() === phraseData.fraseingles.toLowerCase();
                const feedback = document.getElementById('feedback');
                feedback.className = `mt-4 h-8 text-center font-bold ${isCorrect ? 'text-green-600' : 'text-red-600'}`;
                feedback.textContent = isCorrect ? '¡Correcto!' : `Incorrecto. Correcto: ${phraseData.fraseingles}`;
                document.getElementById('check-btn').disabled = true;
                if (isCorrect) {
                    await updateUserPoints(10);
                    setTimeout(advanceInSentenceQueue, 2000);
                } else {
                    document.getElementById('continue-btn').classList.remove('hidden');
                    document.getElementById('continue-btn').addEventListener('click', advanceInSentenceQueue);
                }
            });
        }

        function renderSentenceDictationExercise(audioData) {
            if (!audioData.audio) {
                console.error("No audio available for this phrase.");
                advanceInSentenceQueue();
                return;
            }
            appContainer.innerHTML = `
                <div class="card-style w-full p-6 rounded-2xl text-center">
                    <h2 class="text-2xl font-bold font-heading mb-4">Escribe lo que escuches</h2>
                    <button id="play-audio-btn" class="mb-6 bg-blue-500 text-white rounded-full h-20 w-20 flex items-center justify-center mx-auto text-3xl hover:bg-blue-600 transition"><i class="fas fa-volume-up"></i></button>
                    <input id="sentence-input" type="text" class="w-full border-2 border-gray-300 rounded-lg p-3 text-center text-xl" placeholder="Escribe la frase...">
                    <button id="check-btn" class="w-full btn-primary py-3 rounded-lg font-bold mt-4">Comprobar</button>
                    <div id="feedback" class="mt-4 h-10"></div>
                    <button id="continue-btn" class="hidden w-full bg-gray-500 text-white py-3 rounded-lg font-bold mt-4 flex items-center justify-center"><span>Continuar</span><i class="fas fa-arrow-right ml-2"></i></button>
                </div>`;
            const audio = new Audio(audioData.audio);
            document.getElementById('play-audio-btn').addEventListener('click', () => audio.play().catch(err => console.error("Error playing audio:", err)));
            document.getElementById('check-btn').addEventListener('click', async () => {
                const input = document.getElementById('sentence-input'), feedback = document.getElementById('feedback');
                const cleanInput = input.value.trim().replace(/[.,!?]/g, '').toLowerCase();
                const cleanAnswer = audioData.fraseingles.replace(/[.,!?]/g, '').toLowerCase();
                const isCorrect = cleanInput === cleanAnswer;
                feedback.innerHTML = isCorrect ? `<p class="text-green-600 font-bold">¡Perfecto!</p>` : `<p class="text-red-600 font-bold">Correcto: <span class="block mt-1">${audioData.fraseingles}</span></p>`;
                document.getElementById('check-btn').disabled = true;
                if (isCorrect) {
                    await updateUserPoints(15);
                    setTimeout(advanceInSentenceQueue, 2000);
                } else {
                    document.getElementById('continue-btn').classList.remove('hidden');
                    document.getElementById('continue-btn').addEventListener('click', advanceInSentenceQueue);
                }
            });
            audio.play().catch(err => console.error("Error playing audio:", err));
        }

        // --- 5. FUNCIONES AUXILIARES ---
        async function getNextWordForReview() {
            const now = new Date().toISOString(), group = userProfile.flujo.currentGroup;
            const { data: reviewData, error: reviewError } = await dbClient.from('user_word_progress').select(`srs_level, palabras!inner(*)`) .eq('user_id', currentUser.id).eq('palabras.grupo', group).lte('next_review_at', now).order('next_review_at').limit(1);
            if (reviewError) {
                console.error("Error al obtener revisión:", reviewError);
                return null;
            }
            if (reviewData && reviewData.length > 0) {
                const review = reviewData[0];
                return { ...review.palabras, srs_level: review.srs_level };
            }
            const { data: seen, error: seenError } = await dbClient.from('user_word_progress').select('word_id').eq('user_id', currentUser.id);
            if (seenError) console.error("Error al obtener palabras vistas:", seenError);
            const seenIds = seen ? seen.map(w => w.word_id) : [];
            let query = dbClient.from('palabras').select('*').eq('grupo', group);
            if (seenIds.length > 0) query = query.not('id', 'in', `(${seenIds.join(',')})`);
            const { data: newWordData, error: newWordError } = await query.order('id').limit(1);
            if (newWordError) {
                console.error("Error al obtener nueva palabra:", newWordError);
                return null;
            }
            const newWord = newWordData ? newWordData[0] : null;
            return newWord ? { ...newWord, srs_level: 0 } : null;
        }

        async function generatePracticeQueue() {
            const group = userProfile.flujo.currentGroup;
            const { data: words } = await dbClient.from('palabras').select('id, ingles, imagen, audio').eq('grupo', group);
            if (!words || words.length === 0) return;
            const types = ['select_image_by_audio', 'select_word_by_image', 'write_word_by_image', 'write_word_by_audio'];
            let queue = [];
            words.forEach(word => {
                let type = types[Math.floor(Math.random() * types.length)];
                if ((type === 'select_image_by_audio' || type === 'write_word_by_audio') && !word.audio) {
                    type = types.filter(t => t !== 'select_image_by_audio' && t !== 'write_word_by_audio')[Math.floor(Math.random() * 2)];
                }
                let exercise = { type, word_id: word.id };
                if (type === 'select_image_by_audio') {
                    let options = [word.imagen];
                    let others = words.filter(w => w.id !== word.id).sort(() => .5 - Math.random()).slice(0, 3);
                    options.push(...others.map(w => w.imagen));
                    exercise.options = options;
                } else if (type === 'select_word_by_image') {
                    let options = [word.ingles];
                    let others = words.filter(w => w.id !== word.id).sort(() => .5 - Math.random()).slice(0, 3);
                    options.push(...others.map(w => w.ingles));
                    exercise.options = options;
                }
                queue.push(exercise);
            });
            queue.sort(() => Math.random() - 0.5);
            const newFlow = userProfile.flujo;
            newFlow.flowState[group].flow2_practice = { status: "in_progress", queue, currentIndex: 0 };
            await updateUserFlowState(newFlow);
        }

        async function generateSentenceQueue() {
            const group = userProfile.flujo.currentGroup;
            const { data: frases } = await dbClient.from('frases').select('*').eq('grupo', group);
            const { data: audios } = await dbClient.from('audios').select('*').eq('grupo', group);
            const { data: videos } = await dbClient.from('videos').select('*').eq('grupo', group);
            let queue = [];
            if (videos) videos.forEach(v => queue.push({ type: 'dialogo_video', data: v }));
            if (frases) frases.forEach(f => queue.push({ type: 'organizar_frase', data: f }));
            if (audios) audios.forEach(a => {
                if (a.audio) queue.push({ type: 'escribir_frase', data: a });
            });
            queue.sort(() => Math.random() - 0.5);
            const newFlow = userProfile.flujo;
            newFlow.flowState[group].flow3_sentences = { status: "in_progress", queue, currentIndex: 0 };
            await updateUserFlowState(newFlow);
        }

        async function advanceInQueue() {
            const flow = userProfile.flujo;
            flow.flowState[flow.currentGroup].flow2_practice.currentIndex++;
            await updateUserFlowState(flow);
            await renderFlow2_Practice();
        }

        async function advanceInSentenceQueue() {
            const flow = userProfile.flujo;
            flow.flowState[flow.currentGroup].flow3_sentences.currentIndex++;
            await updateUserFlowState(flow);
            await renderFlow3_Sentences();
        }

        function addFlashcardEventListeners() {
            if (!currentWord.audio) {
                const pronounceBtn = document.getElementById('pronounce-btn');
                if (pronounceBtn) pronounceBtn.disabled = true;
                const soundBtn = document.getElementById('sound-btn');
                if (soundBtn) soundBtn.disabled = true;
                return;
            }
            const audio = new Audio(currentWord.audio);
            const pronounceBtn = document.getElementById('pronounce-btn');
            if (pronounceBtn) pronounceBtn.addEventListener('click', () => {
                document.getElementById('card-phonetic').classList.toggle('hidden');
                audio.play().catch(err => console.error("Error playing audio:", err));
            });
            const soundBtn = document.getElementById('sound-btn');
            if (soundBtn) soundBtn.addEventListener('click', () => {
                audio.play().catch(err => console.error("Error playing audio:", err));
            });
            const handleResponse = async (isEasy) => {
                await updateWordProgress(currentWord.id, isEasy);
                await renderFlow1_Flashcards();
            };
            const btnEasy = document.getElementById('btn-easy');
            if (btnEasy) btnEasy.addEventListener('click', () => handleResponse(true));
            const btnHard = document.getElementById('btn-hard');
            if (btnHard) btnHard.addEventListener('click', () => handleResponse(false));
        }

        async function loadUserProfile() {
            const { data, error } = await dbClient.from('profiles').select('*').eq('id', currentUser.id).single();
            if (error) console.error("Error al cargar perfil:", error);
            userProfile = data;
        }

        async function updateUserFlowState(newFlowState) {
            const { error } = await dbClient.from('profiles').update({ flujo: newFlowState }).eq('id', currentUser.id);
            if (error) console.error("Error al actualizar flujo:", error);
            else userProfile.flujo = newFlowState;
        }

        async function updateUserPoints(pointsToAdd) {
             const newPoints = (userProfile.points || 0) + pointsToAdd;
             await dbClient.from('profiles').update({ points: newPoints }).eq('id', currentUser.id);
             userProfile.points = newPoints;
             const pointsElem = document.getElementById('user-points');
             if (pointsElem) pointsElem.textContent = newPoints;
             const pointsMobileElem = document.getElementById('user-points-mobile');
             if (pointsMobileElem) pointsMobileElem.textContent = newPoints;
        }

        // --- Modal Event Listeners ---
        async function showGlobalRanking() {
            const { data: profiles } = await dbClient.from('profiles').select('full_name, points').order('points', { ascending: false }).limit(10);
            const list = document.getElementById('global-ranking-list');
            list.innerHTML = profiles.map((p, i) => `<li>${i+1}. ${p.full_name || 'Anónimo'} - ${p.points} puntos</li>`).join('');
            showModal('modal-ranking-global');
        }

        async function showEquipoRanking() {
            if (!userProfile.equipo_id) {
                document.getElementById('equipo-ranking-list').innerHTML = '<li>No estás en un equipo.</li>';
                showModal('modal-ranking-equipo');
                return;
            }
            const { data: profiles } = await dbClient.from('profiles').select('full_name, points').eq('equipo_id', userProfile.equipo_id).order('points', { ascending: false }).limit(10);
            const list = document.getElementById('equipo-ranking-list');
            list.innerHTML = profiles.map((p, i) => `<li>${i+1}. ${p.full_name || 'Anónimo'} - ${p.points} puntos</li>`).join('');
            showModal('modal-ranking-equipo');
        }

        function showNivel() {
            const level = Math.floor((userProfile.points || 0) / 100) + 1;
            document.getElementById('user-level').textContent = `Tu nivel actual es: ${level}`;
            showModal('modal-nivel');
        }

        function showProgresoNivel() {
            const points = userProfile.points || 0;
            const progress = (points % 100) + '%';
            document.getElementById('user-progress').textContent = `Progreso al siguiente nivel: ${progress}`;
            showModal('modal-progreso-nivel');
        }

        async function showMazo() {
            const { data: words } = await dbClient.from('user_word_progress').select('palabras!inner(ingles, espanol)').eq('user_id', currentUser.id).gt('srs_level', 0);
            const list = document.getElementById('mazo-list');
            list.innerHTML = words.map(w => `<li>${w.palabras.ingles.toLowerCase()} - ${w.palabras.espanol}</li>`).join('');
            showModal('modal-mazo');
        }

        async function changePassword() {
            showModal('modal-cambiar-pass');
        }

        // --- 6. EJECUCIÓN INICIAL ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { data: { session } } = await dbClient.auth.getSession();
                if (!session) { window.location.href = 'index.html'; return; }
                currentUser = session.user;
                await loadUserProfile();
                if (userProfile) {
                    const nameNav = document.getElementById('user-name-nav');
                    if (nameNav) nameNav.textContent = userProfile.full_name || 'Mi Perfil';
                    const nameDropdown = document.getElementById('user-name-dropdown');
                    if (nameDropdown) nameDropdown.textContent = userProfile.full_name || 'Sin nombre';
                    const emailDropdown = document.getElementById('user-email-dropdown');
                    if (emailDropdown) emailDropdown.textContent = currentUser.email;
                    const pointsElem = document.getElementById('user-points');
                    if (pointsElem) pointsElem.textContent = userProfile.points || 0;
                    const lingotsElem = document.getElementById('user-lingots');
                    if (lingotsElem) lingotsElem.textContent = userProfile.lingots || '0.00';
                    await iniciarFlujoDeAprendizaje();
                } else {
                    appContainer.innerHTML = `<h2 class="text-center font-bold text-red-600">Error al cargar el perfil. Por favor, inicia sesión nuevamente.</h2>`;
                }
            } catch (err) {
                console.error("Error en inicialización:", err);
                appContainer.innerHTML = `<h2 class="text-center font-bold text-red-600">Error al inicializar la aplicación. Por favor, recarga la página.</h2>`;
            }
            const menuButton = document.getElementById('menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const profileMenuButton = document.getElementById('profile-menu-button');
            const profileMenuDropdown = document.getElementById('profile-menu-dropdown');
            if (menuButton) menuButton.addEventListener('click', e => { e.stopPropagation(); if (mobileMenu) mobileMenu.classList.toggle('hidden'); });
            if (profileMenuButton) profileMenuButton.addEventListener('click', e => { e.stopPropagation(); if (profileMenuDropdown) profileMenuDropdown.classList.toggle('hidden'); });
            document.addEventListener('click', e => {
                if (mobileMenu && !mobileMenu.contains(e.target) && menuButton && !menuButton.contains(e.target)) mobileMenu.classList.add('hidden');
                if (profileMenuDropdown && !profileMenuDropdown.contains(e.target) && profileMenuButton && !profileMenuButton.contains(e.target)) profileMenuDropdown.classList.add('hidden');
            });
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) logoutBtn.addEventListener('click', async () => {
                await dbClient.auth.signOut();
                window.location.href = 'index.html';
            });

            // Modal buttons
            const rankingGlobalBtn = document.getElementById('ranking-global-btn');
            if (rankingGlobalBtn) rankingGlobalBtn.addEventListener('click', showGlobalRanking);
            const rankingEquipoBtn = document.getElementById('ranking-equipo-btn');
            if (rankingEquipoBtn) rankingEquipoBtn.addEventListener('click', showEquipoRanking);
            const nivelBtn = document.getElementById('nivel-btn');
            if (nivelBtn) nivelBtn.addEventListener('click', showNivel);
            const progresoNivelBtn = document.getElementById('progreso-nivel-btn');
            if (progresoNivelBtn) progresoNivelBtn.addEventListener('click', showProgresoNivel);
            const mazoBtn = document.getElementById('mazo-btn');
            if (mazoBtn) mazoBtn.addEventListener('click', showMazo);
            const cambiarPassBtn = document.getElementById('cambiar-pass-btn');
            if (cambiarPassBtn) cambiarPassBtn.addEventListener('click', changePassword);

            // Mobile
            const rankingGlobalMobile = document.getElementById('ranking-global-btn-mobile');
            if (rankingGlobalMobile) rankingGlobalMobile.addEventListener('click', showGlobalRanking);
            const rankingEquipoMobile = document.getElementById('ranking-equipo-btn-mobile');
            if (rankingEquipoMobile) rankingEquipoMobile.addEventListener('click', showEquipoRanking);
            const nivelMobile = document.getElementById('nivel-btn-mobile');
            if (nivelMobile) nivelMobile.addEventListener('click', showNivel);
            const progresoNivelMobile = document.getElementById('progreso-nivel-btn-mobile');
            if (progresoNivelMobile) progresoNivelMobile.addEventListener('click', showProgresoNivel);
            const mazoMobile = document.getElementById('mazo-btn-mobile');
            if (mazoMobile) mazoMobile.addEventListener('click', showMazo);
            const cambiarPassMobile = document.getElementById('cambiar-pass-btn-mobile');
            if (cambiarPassMobile) cambiarPassMobile.addEventListener('click', changePassword);

            // Change password logic
            const updatePassBtn = document.getElementById('update-pass-btn');
            if (updatePassBtn) updatePassBtn.addEventListener('click', async () => {
                const newPass = document.getElementById('new-pass').value;
                const confirmPass = document.getElementById('confirm-pass').value;
                if (newPass !== confirmPass) {
                    alert('Las contraseñas no coinciden.');
                    return;
                }
                const { error } = await dbClient.auth.updateUser({ password: newPass });
                if (error) alert('Error al cambiar contraseña: ' + error.message);
                else {
                    alert('Contraseña cambiada exitosamente.');
                    closeModal('modal-cambiar-pass');
                }
            });

            // Save API key
            const saveApiKeyBtn = document.getElementById('save-api-key-btn');
            if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', async () => {
                const apiKey = document.getElementById('api-key-input').value;
                if (!apiKey) return;
                await dbClient.from('profiles').update({ api_key: apiKey }).eq('id', currentUser.id);
                await loadUserProfile();
                closeModal('modal-api-key');
                await renderFlow4_Conversation();
            });

            // Add event listeners for close buttons
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.modal));
            });
        });
    </script>
    <script src="js/igual1.js"></script> 
</body>
</html>
>>>>>>> 0dd812a4c0f5f9cc2f2fc9027e7e92a3e635d9c0
